name: Github CI
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  pipeline:
    runs-on: ubuntu-latest # Os comandos serão executados em um sistema operacional Linux

    steps:
      - name: Git Checkout
        uses: actions/checkout@v2 # Faz o checkout do código recebido

      - name: Build
        run: |
          docker build codigo/posto-ipiranga -t posto-ipiranga

          docker build codigo/postoapp -t postoapp

      - name: tag
        run: |
          docker tag posto-ipiranga ${{ env.REGISTRY }}/plf-es-2023-2-ti3-6654100-posto-ipiranga/nginx-trab:${{ steps.get_latest_version.outputs.latest_version }}
          
          docker tag postoapp ${{ env.REGISTRY }}/plf-es-2023-2-ti3-6654100-posto-ipiranga/front:${{ steps.get_latest_version.outputs.latest_version }}

      - name: Log into registry ghcr.io
        uses: docker/login-action@v1
        with:
          registry: ${{ env.REGISTRY }}
          username: PAlucas
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: push
        run: |
          docker push  ${{ env.REGISTRY }}/plf-es-2023-2-ti3-6654100-posto-ipiranga/posto-ipiranga:${{ steps.get_latest_version.outputs.latest_version }}

          docker push  ${{ env.REGISTRY }}/plf-es-2023-2-ti3-6654100-posto-ipiranga/postoapp:${{ steps.get_latest_version.outputs.latest_version }}